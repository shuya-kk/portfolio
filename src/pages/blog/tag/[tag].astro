---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import BlogCard from "../../../components/BlogCard.astro";
import SectionHeader from "../../../components/SectionHeader.astro";

type Props = {
    posts: CollectionEntry<"blog">[];
    tag: string;
};

export async function getStaticPaths() {
    const allPosts = await getCollection("blog");
    const uniqueTags = new Set<string>();

    allPosts.forEach((post) => {
        post.data.tags?.forEach((tag) => {
            uniqueTags.add(tag);
        });
    });

    return Array.from(uniqueTags).map((tag) => {
        const filteredPosts = allPosts.filter((post) =>
            post.data.tags?.includes(tag),
        );

        return {
            params: { tag: tag },
            props: {
                posts: filteredPosts.sort(
                    (a, b) =>
                        b.data.pubDate.getTime() - a.data.pubDate.getTime(),
                ),
                tag: tag,
            },
        };
    });
}

const { tag, posts } = Astro.props as Props;
---

<Layout title={`タグ: #${tag}`}>
    <div class="max-w-4xl mx-auto px-8 py-32">
        <div class="mb-32">
            <SectionHeader title="タグ別一覧" subtitle={`#${tag}`} />
            <p class="text-center text-zen-dim serif-sub mt-[-2rem]">
                タグ「{tag}」に関連する記録をまとめています。
            </p>
        </div>

        <div class="space-y-6">
            {
                posts.map((post) => (
                    <BlogCard
                        title={post.data.title}
                        date={post.data.pubDate}
                        slug={post.slug}
                        tags={post.data.tags}
                    />
                ))
            }
        </div>
    </div>
</Layout>
